<?xml version='1.0' encoding='UTF-8' ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns:f="http://xmlns.jcp.org/jsf/core" 
      xmlns:h="http://xmlns.jcp.org/jsf/html" 
      xmlns:p="http://primefaces.org/ui" 
      xmlns:ui="http://xmlns.jcp.org/jsf/facelets" 
      xmlns="http://www.w3.org/1999/xhtml">
  <h:head>
    <meta charset="utf-8"></meta>
    <title>SigerWeb - Cuentas</title>
  </h:head>
  <f:metadata>
    <f:event listener="#{indexBean.verificarAcceso('cuentas')}" type="preRenderView" />
  </f:metadata>
  <h:body>
    <p:growl id="growl" showDetail="true" sticky="true" />
    <!-- Overlay Div -->
    <div id="overlay" class="transparent" style="display: none" />
    <ui:include src="barraSuperior.xhtml" />
    <ui:include src="barraLateral.xhtml" />
    <div id="main-container">
      <div id="breadcrumb">
        <ul class="breadcrumb">
          <li>
            <i class="fa fa-home">
            </i>
            <a href="#{indexBean.vista}">Inicio</a>
          </li> 
          <li class="active">
            Cuentas
          </li>
        </ul>
      </div>
      <div class="main-header clearfix">
        <div class="page-title">
          <h3 class="no-margin">Cuentas</h3>
          <span>Consulte todas las cuentas que su despacho esta gestionando o utilice los formularios para buscar un credito en particular</span>
        </div>
      </div>
      <div class="row">
        <div class="padding-md">
          <div class="col-lg-12">
            <h:form id="formCuentas">              
              <table>
                <tr>
                  <td style="padding-bottom: 15px; padding-right: 10px;">
                    <h4 class="no-margin">
                      Gestor:
                    </h4>
                  </td>
                  <td>
                    <p:selectOneMenu value="#{cuentasBean.gestorSeleccionado.idGestor}" style="width:200px">
                      <f:selectItem itemLabel="Todos" itemValue="0" />
                      <f:selectItems value="#{cuentasBean.listaGestores}" var="ges" itemLabel="#{ges.usuario.nombreLogin}" itemValue="#{ges.idGestor}" />
                    </p:selectOneMenu>
                  </td>
                </tr>
                <tr>
                  <td style="padding-bottom: 15px; padding-right: 10px;">
                    <h4 class="no-margin">
                      Campa√±a:
                    </h4>
                  </td>
                  <td>
                    <p:selectOneMenu value="#{cuentasBean.campanaSeleccionada.idCampana}" style="width:300px">
                      <f:selectItem itemLabel="Todas" itemValue="0" />
                      <f:selectItems value="#{cuentasBean.listaCampanas}" var="cam" itemLabel="#{cam.nombre}" itemValue="#{cam.idCampana}" />
                    </p:selectOneMenu>
                  </td>
                </tr>
                <tr>
                  <td style="padding-bottom: 15px; padding-right: 10px;">
                    <h4 class="no-margin">
                      Marcaje:
                    </h4>
                  </td>
                  <td>
                    <p:selectOneMenu value="#{cuentasBean.marcajeSeleccionado.idMarcaje}" style="width:200px">
                      <f:selectItem itemLabel="Todos" itemValue="0" />
                      <f:selectItems value="#{cuentasBean.listaMarcajes}" var="mar" itemLabel="#{mar.marcaje}" itemValue="#{mar.idMarcaje}" />
                    </p:selectOneMenu>
                  </td>
                </tr>
                <tr>
                  <td style="padding-bottom: 15px; padding-right: 10px;">
                    <h4 class="no-margin">
                      Frecuencia de gestion:
                    </h4>
                  </td>
                  <td>
                    <p:selectOneMenu value="#{cuentasBean.colorSeleccionado}" style="width:300px">
                      <f:selectItem itemLabel="Todos" itemValue="0" />
                      <f:selectItem itemLabel="Verde (Hace menos de 3 dias)" itemValue="Verde" />
                      <f:selectItem itemLabel="Amarillo (Hace mas de 3 y menos de 7 dias)" itemValue="Amarillo" />
                      <f:selectItem itemLabel="Rojo (Hace mas de 7 dias)" itemValue="Rojo" />
                    </p:selectOneMenu>
                  </td>
                </tr>
                <tr>
                  <td>
                    <p:commandButton value="Buscar" icon="ui-icon-search" actionListener="#{cuentasBean.prepararCreditos()}" update="cuentas" />
                  </td>
                </tr>
              </table>
              <br />
              <br />
              <div align="center">
                <p:contextMenu for="cuentas" style="width:200px;">
                  <p:menuitem value="Ver Detalle" icon="ui-icon-check" actionListener="#{cuentasBean.selectorDeVista()}" />
                  <p:menuitem value="Devolver" icon="ui-icon-alert" oncomplete="PF('confirmacionDialog').show();" />
                </p:contextMenu>
                <p:dataTable id="cuentas" var="c" value="#{cuentasBean.listaCreditos}" rowKey="#{c.numeroCredito}" selection="#{cuentasBean.creditosSeleccionados}" emptyMessage="No existen creditos gestionables." paginator="true" rows="15" paginatorPosition="bottom" style="width: 1100px;">
                  <p:column selectionMode="multiple" style="width:35px;text-align:center" />
                  <p:column headerText="Credito" style="width:90px;" sortBy="#{c.numeroCredito}">
                    <h:outputText value="#{c.numeroCredito}" style="float:right"/>
                  </p:column>
                  <p:column headerText="Nombre del deudor" style="width:300px;" sortBy="#{c.deudor.sujeto.nombreRazonSocial}" footerText="Total de creditos filtrados en esta busqueda:">
                    <h:outputText value="#{c.deudor.sujeto.nombreRazonSocial}"/>
                  </p:column>
                  <p:column headerText="Saldo vencido" style="width:100px;" sortBy="#{cuentasBean.calcularSaldoVencido(c)}" footerText="#{cuentasBean.listaCreditos.size()}"> 
                    <h:outputText value="#{cuentasBean.calcularSaldoVencido(c)}" style="float:right">
                      <f:convertNumber locale="es-MX" maxFractionDigits="2" currencySymbol="$" minFractionDigits="2" type="currency" />
                    </h:outputText>
                  </p:column>
                  <p:column headerText="Institucion" style="width:100px;" sortBy="#{c.producto.institucion.nombreCorto}">
                    <h:outputText value="#{c.producto.institucion.nombreCorto}"/>
                  </p:column>
                  <p:column headerText="Producto" style="width:200px;" sortBy="#{c.producto.nombre}">
                    <h:outputText value="#{c.subproducto.nombre}"/>
                  </p:column>
                  <p:column headerText="Gestor" style="width:100px;" sortBy="#{c.gestor.usuario.nombreLogin}">
                    <h:outputText value="#{c.gestor.usuario.nombreLogin}"/>
                  </p:column>
                  <f:facet name="footer">
                    <p:commandButton value="Reasignar creditos seleccionados" icon="ui-icon-refresh" oncomplete="PF('reasignacionDialog').show();" />
                  </f:facet>
                </p:dataTable>
              </div>
              <hr />
              <div align="center">
                <h4 class="no-margin">
                  Estatus de cuentas actualmente:
                </h4>
                <br />
                <p:dataTable id="estatusCuentas" var="ec" value="#{cuentasBean.listaCuentasGestor}" emptyMessage="No existe informacion de cuentas y gestores." paginator="true" rows="15" paginatorPosition="bottom" style="width: 800px;">
                  <p:column headerText="Gestor" style="width:100px;">
                    <h:outputText value="#{ec.gestor.usuario.nombreLogin}"/>
                  </p:column>
                  <p:column headerText="Cuentas normales" style="width:100px;" sortBy="#{ec.cuentas}">
                    <h:outputText value="#{ec.cuentas}" style="float:right"/>
                  </p:column>
                  <p:column headerText="Saldo vencido" style="width:150px;" sortBy="#{ec.montoCuentas}"> 
                    <h:outputText value="#{ec.montoCuentas}" style="float:right">
                      <f:convertNumber locale="es-MX" maxFractionDigits="2" currencySymbol="$" minFractionDigits="2" type="currency" />
                    </h:outputText>
                  </p:column>
                  <p:column headerText="Cuentas quebranto" style="width:100px;" sortBy="#{ec.cuentasQuebranto}">
                    <h:outputText value="#{ec.cuentasQuebranto}" style="float:right"/>
                  </p:column>
                  <p:column headerText="Saldo vencido" style="width:150px;" sortBy="#{ec.montoCuentasQuebranto}"> 
                    <h:outputText value="#{ec.montoCuentasQuebranto}" style="float:right">
                      <f:convertNumber locale="es-MX" maxFractionDigits="2" currencySymbol="$" minFractionDigits="2" type="currency" />
                    </h:outputText>
                  </p:column>
                  <p:column headerText="Saldo vencido total" style="width:150px;" sortBy="#{cuentasBean.calcularSaldoVencido(c)}"> 
                    <h:outputText value="#{ec.montoTotal}" style="float:right">
                      <f:convertNumber locale="es-MX" maxFractionDigits="2" currencySymbol="$" minFractionDigits="2" type="currency" />
                    </h:outputText>
                  </p:column>
                </p:dataTable>
              </div>
            </h:form>
          </div>
        </div>
      </div>
    </div><!-- /main-container -->
    <!-- Footer ================================================== -->
    <ui:include src="barraInferior.xhtml" />
  </h:body>
  <!-- DIALOGO PARA DEVOLUCION   -->
  <p:dialog id="dlg1" widgetVar="confirmacionDialog" modal="true" header="Confirme esta devolucion">
    <h:form id="devolucionDirectaForm">
      <h:outputText value="Esta seguro de que desea devolver este credito?" />
      <br />
      <br />
      <h:outputText value="Esta accion hara que el credito ya no se pueda gestionar." />
      <br />
      <br />
      Seleccione el concepto de devolucion:
      <br />
      <p:selectOneMenu id="concepto" value="#{cuentasBean.conceptoSeleccionado.idConceptoDevolucion}" style="width:200px">
        <f:selectItem itemLabel="" itemValue="0" />
        <f:selectItems value="#{cuentasBean.listaConceptos}" var="c" itemLabel="#{c.concepto}" itemValue="#{c.idConceptoDevolucion}" />
        <p:ajax listener="#{cuentasBean.preparaMotivos()}" update="motivo" />
      </p:selectOneMenu>
      <br />
      <br />
      Seleccione el motivo de la devolucion:
      <br />
      <p:selectOneMenu id="motivo" value="#{cuentasBean.motivoSeleccionado.idMotivoDevolucion}" style="width:200px">
        <f:selectItem itemLabel="" itemValue="0" />
        <f:selectItems value="#{cuentasBean.listaMotivos}" var="m" itemLabel="#{m.motivo}" itemValue="#{m.idMotivoDevolucion}" />
      </p:selectOneMenu>
      <br />
      <br />
      Observaciones:
      <br />
      <p:inputText value="#{cuentasBean.observaciones}" style="width:300px" />
      <br />
      <br />
      <p:commandButton value="Devolver" icon="ui-icon-check" actionListener="#{cuentasBean.devolverDirecto()}" update="growl" />
      &nbsp;&nbsp;&nbsp;&nbsp;
      <p:commandButton value="Cancelar" icon="ui-icon-close" oncomplete="PF('confirmacionDialog').hide();" />
    </h:form>
  </p:dialog>
  <!-- DIALOGO PARA REASIGNACION -->
  <p:dialog id="dlgReasignacionDirecta" widgetVar="reasignacionDialog" modal="true" header="Confirme esta reasignacion">
    <h:form id="reasignacionDirectaForm">
      Realmente desea reasignar este(estos) credito(s)?
      <br />
      <br />
      Seleccione el gestor al que reasignara los creditos:
      <br />
      <br />
      <p:selectOneMenu id="listaGestoresVistaCuentas" value="#{cuentasBean.gestorSeleccionado.idGestor}" style="width:200px">
        <f:selectItems value="#{cuentasBean.listaGestores}" var="ges" itemLabel="#{ges.usuario.nombreLogin}" itemValue="#{ges.idGestor}" />
      </p:selectOneMenu>
      <br />
      <br />
      <div align="center">
        <p:commandButton value="Si" icon="ui-icon-check" oncomplete="PF('reasignacionDialog').hide();" actionListener="#{cuentasBean.reasignarGestor(cuentasBean.creditosSeleccionados)}" update=":growl, formCuentas:cuentas" />
        &nbsp;&nbsp;&nbsp;&nbsp;
        <p:commandButton value="No" icon="ui-icon-close" oncomplete="PF('reasignacionDialog').hide();" />
      </div>
    </h:form>
  </p:dialog>

  <!-- DIALOGO BARRA DE CARGA -->
  <p:ajaxStatus onstart="PF('statusDialog').show()" onsuccess="PF('statusDialog').hide()" />
  <p:dialog widgetVar="statusDialog" modal="true" draggable="false" closable="false" resizable="false" showHeader="false" >
    <p:graphicImage library="img" name="loadingBarra.gif" />
  </p:dialog>
</html>