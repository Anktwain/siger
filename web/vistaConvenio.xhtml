<?xml version='1.0' encoding='UTF-8' ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns:h="http://xmlns.jcp.org/jsf/html" 
      xmlns:p="http://primefaces.org/ui" 
      xmlns:ui="http://xmlns.jcp.org/jsf/facelets" 
      xmlns="http://www.w3.org/1999/xhtml">
  <h:head>
    <meta charset="utf-8"></meta>
    <title>SigerWeb - Convenios</title>
    <link rel="shortcut icon" href="resources/img/icono.ico" type="image/x-icon" />
  </h:head> 
  <body>
    <p:growl id="growl" showDetail="true" sticky="true" />
    <!-- Overlay Div -->
    <div id="overlay" class="transparent" style="display: none"></div>
    <ui:include src="barraSuperior.xhtml" />
    <ui:include src="barraLateral.xhtml" />
    <div id="main-container">
      <h:form rendered="#{!indexBean.adminVisible}">
        <div id="breadcrumb">
          <ul class="breadcrumb">
            <li>
              <i class="fa fa-home">
              </i>
              <a href="#{indexBean.vista}">Inicio</a>
            </li>
            <li>
              Campa√±a: <h:outputText value="#{cuentasGestorBean.seleccion.nombreCampana}" />
            </li>
            <li>
              <a href="vistaCampanaActual.xhtml">Detalle credito <p:outputLabel value="#{creditoActualBean.creditoActual.numeroCredito}" /></a>
            </li>
            <li class="active">
              Convenios de pago
            </li>
          </ul>
        </div>
      </h:form>
      <div class="padding-md">
        <h:form id="formConvenios">
          <div>
            <div class="clearfix" style="width: 1100px;">
              <div class="pull-left">
                <h3>Convenio en curso</h3>
                <p:dataTable id="convenioEnCurso" var="c" value="#{conveniosBean.convenioActivo}" emptyMessage="No existe convenio en curso." style="width:420px;">
                  <p:column headerText="Fecha" style="width:100px;">
                    <h:outputText value="#{c.fecha}"/>
                  </p:column>
                  <p:column headerText="Saldo negociado" style="width:150px;"> 
                    <h:outputText value="#{c.saldoNegociado}"/>
                  </p:column>
                  <p:column headerText="Pagos prometidos" style="width:150px;"> 
                    <h:outputText value="#{c.pagosNegociados  }"/>
                  </p:column>
                </p:dataTable>
                <br />
                <p:commandButton id="botonNuevoConvenio" value="Agregar convenio" oncomplete="PF('agregarConvenioDialog').show();" disabled="#{conveniosBean.habilitaConvenios}"/>
                &nbsp;&nbsp;&nbsp;&nbsp;
                <p:commandButton id="botonFinalizarConvenio" value="Finalizar convenio" actionListener="#{conveniosBean.finalizarConvenio()}" disabled="#{conveniosBean.habilitaPromesas}" update=":growl, convenioEnCurso, botonNuevoConvenio, pagosConvenioEnCurso" />
                <br />
                <br />
                <p:accordionPanel activeIndex="-1" style="width:420px;">
                  <p:tab title="Promesas en este convenio">
                    <p:contextMenu for="promesasEnCurso" style="width:200px;">
                      <p:menuitem value="Agregar pago" icon="ui-icon-folder-collapsed" oncomplete="PF('agregarPagoDialog').show();" />
                    </p:contextMenu>
                    <p:dataTable id="promesasEnCurso" var="p" value="#{conveniosBean.listaPromesas}" rowKey="#{p.idPromesaPago}" selection="#{conveniosBean.promesaSeleccionada}" emptyMessage="No existen promesas de pago." selectionMode="single" paginator="true" paginatorAlwaysVisible="false" rows="15" paginatorPosition="bottom" style="width:270px;">
                      <p:column headerText="Fecha de pago" style="width:100px;">
                        <h:outputText value="#{p.fechaPrometida}"/>
                      </p:column>
                      <p:column headerText="Saldo negociado" style="width:150px;"> 
                          <h:outputText value="#{p.cantidadPrometida}"/>
                      </p:column>
                    </p:dataTable>
                  </p:tab>
                </p:accordionPanel>
                <br />
                <p:commandButton id="botonNuevaPromesa" value="Agregar promesa de pago" oncomplete="PF('agregarPromesaDialog').show();" disabled="#{conveniosBean.habilitaPromesas}"/>
              </div>
              <div class="pull-right">
                <h3>Pagos realizados en este convenio</h3>
                <p:dataTable id="pagosConvenioEnCurso" var="p" value="#{conveniosBean.listaPagosConvenioActivo}" emptyMessage="No se han realizado pagos." paginator="true" paginatorAlwaysVisible="false" rows="15" paginatorPosition="bottom" style="width:620px;">
                  <p:column headerText="Fecha de deposito" style="width:100px;">
                    <h:outputText value="#{p.fechaDeposito}"/>
                  </p:column>
                  <p:column headerText="Monto" style="width:100px;"> 
                    <h:outputText value="#{p.monto}"/>
                  </p:column>
                  <p:column headerText="Revisor" style="width:100px;"> 
                    <h:outputText value="#{p.revisor}"/>
                  </p:column>
                  <p:column headerText="Observaciones" style="width:200px;"> 
                    <h:outputText value="#{p.observaciones}"/>
                  </p:column>
                  <p:column headerText="Estatus" style="width:100px;"> 
                    <h:outputText value="#{conveniosBean.etiquetarEstatus(p.estatus)}"/>
                  </p:column>
                </p:dataTable>
              </div>
            </div>
            <hr />
            <div class="clearfix" style="width: 1200px;">
              <div class="pull-left">
                <h3>Historial de convenios</h3>
                <br />
                <p:accordionPanel activeIndex="-1" style="width:510px;">
                  <p:tab title="Historial">
                    <p:dataTable id="historialConvenios" var="c" value="#{conveniosBean.listaHistorialConvenios}" emptyMessage="No existen otros convenios." paginator="true" paginatorAlwaysVisible="false" rows="15" paginatorPosition="bottom"  style="width:470px;">
                      <p:column headerText="Convenio" style="width:100px;">
                        <h:outputText value="#{c.idConvenioPago}"/>
                      </p:column>
                      <p:column headerText="Fecha" style="width:100px;">
                        <h:outputText value="#{c.fecha}"/>
                      </p:column>
                      <p:column headerText="Saldo negociado" style="width:150px;"> 
                        <h:outputText value="#{c.saldoNegociado}"/>
                      </p:column>
                      <p:column headerText="Pagos" style="width:100px;"> 
                        <h:outputText value="#{c.pagosNegociados}"/>
                      </p:column>
                    </p:dataTable>
                  </p:tab>
                </p:accordionPanel>
              </div>
              <div class="pull-right">
                  <!-- TO DO: -->
                  <!-- reparar la consulta, puesto que trae todos los pagos no solo los de este crtedito -->
                <h3>Historial de pagos</h3>
                <br />
                <p:accordionPanel activeIndex="-1" style="width:660px;">
                  <p:tab title="Historial">
                    <p:dataTable id="historialPagos" var="p" value="#{conveniosBean.listaHistorialPagos}" emptyMessage="No existen otros pagos." paginator="true" paginatorAlwaysVisible="false" rows="15" paginatorPosition="bottom"  style="width:620px;">
                      <p:column headerText="Convenio" style="width:100px;">
                        <h:outputText value="#{p.promesaPago.convenioPago.idConvenioPago}"/>
                      </p:column>
                      <p:column headerText="Fecha deposito" style="width:130px;">
                        <h:outputText value="#{p.fechaDeposito}"/>
                      </p:column>
                      <p:column headerText="Monto" style="width:100px;"> 
                        <h:outputText value="#{p.monto}"/>
                      </p:column>
                      <p:column headerText="Revisor" style="width:100px;"> 
                        <h:outputText value="#{p.revisor}"/>
                      </p:column>
                      <p:column headerText="Observaciones" style="width:180px;"> 
                        <h:outputText value="#{p.observaciones}"/>
                      </p:column>
                    </p:dataTable>
                  </p:tab>
                </p:accordionPanel>
              </div>
            </div>
          </div>
        </h:form>
        <p:dialog id="dlgPago" widgetVar="agregarPagoDialog" modal="true" header="Agregar pago">
          <h:form enctype="multipart/form-data">
            Cantidad:
            &nbsp;&nbsp;&nbsp;&nbsp;
            <p:inputText value="#{conveniosBean.saldoNuevoPago}" required="true" requiredMessage="Debe ingresar una cantidad." />
            <br />
            <br />
            Fecha de deposito:
            &nbsp;&nbsp;&nbsp;&nbsp;
            <p:calendar value="#{conveniosBean.fechaDeposito}" showOn="button" required="true" requiredMessage="Debe indicar una fecha de deposito." />
            <br />
            <br />
            Numero de cuenta:
            &nbsp;&nbsp;&nbsp;&nbsp;
            <p:inputText value="#{conveniosBean.cuentaPago}" required="true" requiredMessage="Debe ingresar un numero de cuenta." />
            <br />
            <br />
            Observaciones:
            &nbsp;&nbsp;&nbsp;&nbsp;
            <p:inputText value="#{conveniosBean.observacionesPago}" />
            <br />
            <br />
            <p:fileUpload fileUploadListener="#{conveniosBean.eventoDeCarga}" mode="advanced" auto="true" label="Seleccionar archivo" style="width: 200px;" required="true" sizeLimit="3000000" fileLimit="1" allowTypes="/(\.|\/)(jpe?g|png|pdf)$/" update=":growl" />
            <br />
            <p:commandButton id="botonEnviarPago" value="Enviar" actionListener="#{conveniosBean.agregarPago()}" update=":growl, formConvenios:pagosConvenioEnCurso, @([id$=revisionPagos])" />
          </h:form>
        </p:dialog>
        <p:dialog id="dlgNuevoConvenio" widgetVar="agregarConvenioDialog" modal="true" header="Agregar convenio">
          <h:form>
            Monto maximo:
            &nbsp;&nbsp;&nbsp;&nbsp;
            <p:outputLabel value="#{conveniosBean.saldoMaximo}" />
            <br />
            Monto negociado:
            &nbsp;&nbsp;&nbsp;&nbsp;
            <p:inputText value="#{conveniosBean.saldoNuevoConvenio}" required="true" requiredMessage="Debe ingresar una cantidad." />
            <br />
            Pagos pactados:
            &nbsp;&nbsp;&nbsp;&nbsp;
            <p:inputText value="#{conveniosBean.pagosPrometidos}" />
            <br />
            <br />
            Con quita de capital
            &nbsp;&nbsp;
            <p:selectBooleanCheckbox value="#{conveniosBean.quitaCapital}" />
            &nbsp;&nbsp;&nbsp;&nbsp;
            Sin contacto
            &nbsp;&nbsp;
            <p:selectBooleanCheckbox value="#{conveniosBean.sinContacto}" />
            <br />
            <br />
            <p:commandButton value="Ok" actionListener="#{conveniosBean.agregarConvenio()}" update=":growl, formConvenios:convenioEnCurso, formConvenios:botonNuevoConvenio" />
          </h:form>
        </p:dialog>
        <p:dialog id="dlgNuevaPromesa" widgetVar="agregarPromesaDialog" modal="true" header="Agregar promesa">
          <h:form id="dlgNuevaPromesaForm">
            Monto negociado:
            &nbsp;&nbsp;&nbsp;&nbsp;
            <p:inputText value="#{conveniosBean.saldoNuevaPromesa}" required="true" requiredMessage="Debe ingresar una cantidad." />
            <br />
            Fecha pactada:
            &nbsp;&nbsp;&nbsp;&nbsp;
            <p:calendar id="startDate" value="#{conveniosBean.fechaNuevaPromesa}" showOn="button" required="true" requiredMessage="Debe indicar una fecha." />
            <br />
            <p:commandButton value="Ok" actionListener="#{conveniosBean.agregarPromesa()}" update="growl" />
          </h:form>
        </p:dialog>
      </div>
    </div><!-- /main-container -->
    <!-- Footer ================================================== -->
    <ui:include src="barraInferior.xhtml" />
  </body>
</html>