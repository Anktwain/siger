<?xml version='1.0' encoding='UTF-8' ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns:h="http://xmlns.jcp.org/jsf/html" 
      xmlns:p="http://primefaces.org/ui" 
      xmlns:ui="http://xmlns.jcp.org/jsf/facelets" 
      xmlns="http://www.w3.org/1999/xhtml"
      xmlns:f="http://xmlns.jcp.org/jsf/core">
  <h:head>
    <meta charset="utf-8"></meta>
    <title>SigerWeb - Convenios</title>
    <link rel="shortcut icon" href="resources/img/icono.ico" type="image/x-icon" />
  </h:head> 
  <body>
    <p:growl id="growl" showDetail="true" sticky="true" />
    <!-- Overlay Div -->
    <div id="overlay" class="transparent" style="display: none"></div>
    <ui:include src="barraSuperior.xhtml" />
    <ui:include src="barraLateral.xhtml" />
    <div id="main-container">
      <h:form rendered="#{!indexBean.adminVisible}">
        <div id="breadcrumb">
          <ul class="breadcrumb">
            <li>
              <i class="fa fa-home">
              </i>
              <a href="#{indexBean.vista}">Inicio</a>
            </li>
            <li>
              Campa√±a: <h:outputText value="#{cuentasGestorBean.seleccion.nombreCampana}" />
            </li>
            <li>
              <a href="vistaCampanaActual.xhtml">Detalle credito <p:outputLabel value="#{creditoActualBean.creditoActual.numeroCredito}" /></a>
            </li>
            <li class="active">
              Convenios de pago
            </li>
          </ul>
        </div>
      </h:form>
      <h:form rendered="#{indexBean.adminVisible}">
        <div id="breadcrumb">
          <ul class="breadcrumb">
            <li>
              <i class="fa fa-home">
              </i>
              <a href="#{indexBean.vista}">Inicio</a>
            </li>
            <li>
              <a href="cuentas.xhtml">Cuentas</a>
            </li>
            <li>
              <a href="vistaCreditoAdmin.xhtml">Detalle credito <p:outputLabel value="#{creditoActualBean.creditoActual.numeroCredito}" /></a>
            </li>
            <li class="active">
              Convenios de pago
            </li>
          </ul>
        </div>
      </h:form>
      <div class="padding-md">
        <h:form id="formConvenios">
          <div>
            <div class="clearfix" style="width: 1100px;">
              <div class="pull-left">
                <h3>Convenio en curso</h3>
                <p:dataTable id="convenioEnCurso" var="c" value="#{conveniosBean.convenioActivo}" emptyMessage="No existe convenio en curso." style="width:420px;">
                  <p:column headerText="Fecha" style="width:100px;">
                    <h:outputText value="#{c.fecha}"/>
                  </p:column>
                  <p:column headerText="Saldo negociado" style="width:150px;"> 
                    <h:outputText value="#{c.saldoNegociado}"/>
                  </p:column>
                  <p:column headerText="Pagos prometidos" style="width:150px;"> 
                    <h:outputText value="#{c.pagosNegociados  }"/>
                  </p:column>
                </p:dataTable>
                <br />
                <p:commandButton id="botonNuevoConvenio" value="Agregar convenio" oncomplete="PF('agregarConvenioDialog').show();" disabled="#{conveniosBean.habilitaConvenios}"/>
                &nbsp;&nbsp;&nbsp;&nbsp;
                <p:commandButton id="botonFinalizarConvenio" value="Finalizar convenio" actionListener="#{conveniosBean.finalizarConvenio()}" disabled="#{!conveniosBean.habilitaConvenios}" update=":growl, convenioEnCurso, botonNuevoConvenio, pagosConvenioEnCurso, formConvenios" />
                <br />
                <br />
                <p:accordionPanel activeIndex="0" style="width:420px;">
                  <p:tab title="Promesas en este convenio">
                    <p:contextMenu for="promesasEnCurso" style="width:200px;">
                      <p:menuitem value="Agregar pago" icon="ui-icon-folder-collapsed" actionListener="#{conveniosBean.inicializarMontoPago()}" oncomplete="PF('agregarPagoDialog').show();" update="agregarPagoForm" />
                    </p:contextMenu>
                    <p:dataTable id="promesasEnCurso" var="promesa" value="#{conveniosBean.listaPromesas}" rowKey="#{promesa.idPromesaPago}" selection="#{conveniosBean.promesaSeleccionada}" emptyMessage="No existen promesas de pago." selectionMode="single" paginator="true" paginatorAlwaysVisible="false" rows="15" paginatorPosition="bottom" style="width:270px;" disabledSelection="#{!conveniosBean.habilitaCargaPagos()}">
                      <p:column headerText="Fecha de pago" style="width:100px;">
                        <h:outputText value="#{promesa.fechaPrometida}"/>
                      </p:column>
                      <p:column headerText="Saldo negociado" style="width:150px;"> 
                        <h:outputText value="#{promesa.cantidadPrometida}"/>
                      </p:column>
                    </p:dataTable>
                  </p:tab>
                </p:accordionPanel>
              </div>
              <div class="pull-right">
                <h3>Pagos realizados en este convenio</h3>
                <p:dataTable id="pagosConvenioEnCurso" var="p" value="#{conveniosBean.listaPagosConvenioActivo}" emptyMessage="No se han realizado pagos." paginator="true" paginatorAlwaysVisible="false" rows="15" paginatorPosition="bottom" style="width:620px;">
                  <p:column headerText="Fecha de deposito" style="width:100px;">
                    <h:outputText value="#{p.fechaDeposito}"/>
                  </p:column>
                  <p:column headerText="Monto" style="width:100px;"> 
                    <h:outputText value="#{p.montoPago}"/>
                  </p:column>
                  <p:column headerText="Revisor" style="width:100px;"> 
                    <h:outputText value="#{p.revisor}"/>
                  </p:column>
                  <p:column headerText="Observaciones" style="width:200px;"> 
                    <h:outputText value="#{p.observacionRevisor}"/>
                  </p:column>
                  <p:column headerText="Estatus" style="width:100px;"> 
                    <h:outputText value="#{conveniosBean.etiquetarEstatus(p.estatus)}"/>
                  </p:column>
                </p:dataTable>
              </div>
            </div>
            <hr />
            <div class="clearfix" style="width: 1200px;">
              <div class="pull-left">
                <h3>Historial de convenios</h3>
                <br />
                <p:accordionPanel activeIndex="-1" style="width:510px;">
                  <p:tab title="Historial">
                    <p:dataTable id="historialConvenios" var="c" value="#{conveniosBean.listaHistorialConvenios}" emptyMessage="No existen otros convenios." paginator="true" paginatorAlwaysVisible="false" rows="15" paginatorPosition="bottom"  style="width:470px;">
                      <p:column headerText="Convenio" style="width:100px;">
                        <h:outputText value="#{c.idConvenioPago}"/>
                      </p:column>
                      <p:column headerText="Fecha" style="width:100px;">
                        <h:outputText value="#{c.fecha}"/>
                      </p:column>
                      <p:column headerText="Saldo negociado" style="width:150px;"> 
                        <h:outputText value="#{c.saldoNegociado}"/>
                      </p:column>
                      <p:column headerText="Pagos" style="width:100px;"> 
                        <h:outputText value="#{c.pagosNegociados}"/>
                      </p:column>
                    </p:dataTable>
                  </p:tab>
                </p:accordionPanel>
              </div>
              <div class="pull-right">
                <!-- TO DO: -->
                <!-- reparar la consulta, puesto que trae todos los pagos no solo los de este crtedito -->
                <h3>Historial de pagos</h3>
                <br />
                <p:accordionPanel activeIndex="-1" style="width:660px;">
                  <p:tab title="Historial">
                    <p:dataTable id="historialPagos" var="p" value="#{conveniosBean.listaHistorialPagos}" emptyMessage="No existen otros pagos." paginator="true" paginatorAlwaysVisible="false" rows="15" paginatorPosition="bottom"  style="width:620px;">
                      <p:column headerText="Convenio" style="width:100px;">
                        <h:outputText value="#{p.promesaPago.convenioPago.idConvenioPago}"/>
                      </p:column>
                      <p:column headerText="Fecha deposito" style="width:130px;">
                        <h:outputText value="#{p.fechaDeposito}"/>
                      </p:column>
                      <p:column headerText="Monto" style="width:100px;"> 
                        <h:outputText value="#{p.montoAprobado}"/>
                      </p:column>
                      <p:column headerText="Revisor" style="width:100px;"> 
                        <h:outputText value="#{p.revisor}"/>
                      </p:column>
                      <p:column headerText="Observaciones" style="width:180px;"> 
                        <h:outputText value="#{p.informacionRevision}"/>
                      </p:column>
                    </p:dataTable>
                  </p:tab>
                </p:accordionPanel>
              </div>
            </div>
          </div>
        </h:form>
        <p:dialog id="dlgPago" widgetVar="agregarPagoDialog" modal="true" header="Agregar pago" closable="false">
          <h:form id="agregarPagoForm" enctype="multipart/form-data">
            Cargue los comprobantes:
            <br />
            <br />
            <p:fileUpload 
              value="#{conveniosBean.archivo}"
              fileUploadListener="#{conveniosBean.eventoDeCarga}" 
              multiple="true" 
              mode="advanced" 
              label="Seleccionar archivo" 
              sizeLimit="5242880" invalidSizeMessage="Error. El archivo excede 5 MB" 
              fileLimit="3" fileLimitMessage="Error. Se pueden cargar como maximo 3 archivos." 
              allowTypes="/(\.|\/)(jpe?g|png|pdf|bmp)$/" invalidFileMessage="Error. Este formato de archivo no esta permitido." 
              auto="true" 
              update=":growl, agregarPagoForm" 
              required="true" 
              style="width: 400px;" 
              rendered="#{conveniosBean.habilitaCarga}" 
              />
            <br />
            Archivos cargados al servidor:
            &nbsp;
            <h:outputText value="#{conveniosBean.listaNombresComprobantes.size()}"  />
            <br />
            <br />
            Cantidad:
            &nbsp;&nbsp;&nbsp;&nbsp;
            <p:inputText value="#{conveniosBean.saldoNuevoPago}" required="true" requiredMessage="Debe ingresar una cantidad." />
            <br />
            <br />
            Fecha de deposito:
            &nbsp;&nbsp;&nbsp;&nbsp;
            <p:calendar value="#{conveniosBean.fechaDeposito}" showOn="button" required="true" requiredMessage="Debe indicar una fecha de deposito." />
            <br />
            <br />
            <h:outputText value="En ventanilla (#{conveniosBean.promesaSeleccionada.convenioPago.credito.numeroCredito})" />
            &nbsp;&nbsp;&nbsp;&nbsp;
            <p:selectBooleanCheckbox id="booleanVentanilla" value="#{conveniosBean.ventanilla}" disabled="#{conveniosBean.habilitaVentanilla}">
              <p:ajax listener="#{conveniosBean.cambiarLeyenda()}" update="agregarPagoForm:booleanAsociada, agregarPagoForm:cuentasPago, agregarPagoForm:observacionesPagoGestor" />
            </p:selectBooleanCheckbox>
            <br />
            <br />
            <h:outputText value="Cuenta asociada (#{conveniosBean.promesaSeleccionada.convenioPago.credito.numeroCuenta})" />
            &nbsp;&nbsp;&nbsp;&nbsp;
            <p:selectBooleanCheckbox id="booleanAsociada" value="#{conveniosBean.cuentaAsociada}"  disabled="#{conveniosBean.habilitaAsociada}">
              <p:ajax listener="#{conveniosBean.controlCuentaPago(2)}" update="agregarPagoForm:booleanVentanilla, agregarPagoForm:cuentasPago" />
            </p:selectBooleanCheckbox>
            <br />
            <br />
            Cuenta concentradora:
            &nbsp;&nbsp;&nbsp;&nbsp;
            <p:selectOneMenu id="cuentasPago" value="#{conveniosBean.cuentaPago}" disabled="#{conveniosBean.habilitaCuentas}">
              <f:selectItem itemLabel="" itemValue="" />
              <f:selectItems value="#{conveniosBean.listaCuentasPago}" />
              <p:ajax event="change" listener="#{conveniosBean.controlCuentaPago(3)}" update="agregarPagoForm:booleanVentanilla, agregarPagoForm:booleanAsociada" />
            </p:selectOneMenu>
            <br />
            <br />
            Observaciones:
            <br />
            <br />
            <p:inputText id="observacionesPagoGestor" value="#{conveniosBean.observacionesPago}" size="40" maxlength="50" />
            <br />
            <br />
            <div align="center">
              <p:commandButton value="Enviar" icon="ui-icon-check" actionListener="#{conveniosBean.agregarPago()}" update=":growl, formConvenios:pagosConvenioEnCurso" />
              &nbsp;&nbsp;&nbsp;&nbsp;
              <p:commandButton value="Cancelar" icon="ui-icon-close" actionListener="#{conveniosBean.cancelar()}" process="@this" />
            </div>
          </h:form>
        </p:dialog>
        <p:dialog id="dlgNuevoConvenio" widgetVar="agregarConvenioDialog" modal="true" header="Agregar convenio" position="top" closable="false">
          <h:form id="nuevoConvenioForm">
            <p:outputPanel style="text-align:center;">
              <p:panelGrid columns="2">
                Monto maximo:
                &nbsp;&nbsp;&nbsp;&nbsp;
                <p:outputLabel value="#{conveniosBean.saldoMaximo}" />
                <br />
                Monto negociado:
                &nbsp;&nbsp;&nbsp;&nbsp;
                <p:inputText value="#{conveniosBean.saldoNuevoConvenio}" required="true" requiredMessage="Debe ingresar una cantidad." disabled="#{conveniosBean.habilitaPromesas}" />
                <br />
                Pagos pactados:
                &nbsp;&nbsp;&nbsp;&nbsp;
                <p:inputText value="#{conveniosBean.pagosPrometidos}" disabled="#{conveniosBean.habilitaPromesas}" />
                <br />
                El convenio se realizo con:
                &nbsp;&nbsp;&nbsp;&nbsp;
                <p:selectOneMenu value="#{conveniosBean.sujetoConvenio}" style="width:200px" disabled="#{conveniosBean.habilitaPromesas}">
                  <f:selectItems value="#{conveniosBean.listaSujetos}" var="s" itemLabel="#{s}" itemValue="#{s}" />
                </p:selectOneMenu>
              </p:panelGrid>
            </p:outputPanel>
            <br />
            <div align="center">
              Con quita de capital
              &nbsp;&nbsp;
              <p:selectBooleanCheckbox value="#{conveniosBean.quitaCapital}" />
              &nbsp;&nbsp;&nbsp;&nbsp;
              Sin contacto
              &nbsp;&nbsp;
              <p:selectBooleanCheckbox value="#{conveniosBean.sinContacto}" />
            </div>
            <br />
            <div align="center">
              <p:commandButton value="Agregar convenio" icon="ui-icon-check" actionListener="#{conveniosBean.agregarConvenio()}" update=":growl, formConvenios:convenioEnCurso, formConvenios:botonNuevoConvenio, :nuevaPromesaForm, nuevoConvenioForm" rendered="#{!conveniosBean.habilitaPromesas}" />
              &nbsp;&nbsp;&nbsp;&nbsp;
              <p:commandButton value="Cancelar" icon="ui-icon-close" actionListener="#{conveniosBean.cancelar()}" oncomplete="PF('agregarConvenioDialog').hide();" rendered="#{!conveniosBean.habilitaPromesas}" />
            </div>
            <br />
          </h:form>
          <h:form id="nuevaPromesaForm">
            <p:outputPanel style="text-align:center;" rendered="#{conveniosBean.habilita1}">
              <p:panelGrid columns="2">
                <f:facet name="header">
                  Promesa de pago # 1
                </f:facet>
                Monto negociado:
                &nbsp;&nbsp;&nbsp;&nbsp;
                <p:inputText value="#{conveniosBean.saldosNuevasPromesas[0]}" required="true" requiredMessage="Debe ingresar una cantidad." />
                Fecha pactada:
                &nbsp;&nbsp;&nbsp;&nbsp;
                <p:calendar value="#{conveniosBean.fechasNuevasPromesas[0]}" showOn="button" required="true" requiredMessage="Debe indicar una fecha." />
              </p:panelGrid>
            </p:outputPanel>
            <p:outputPanel style="text-align:center;" rendered="#{conveniosBean.habilita2}">
              <p:panelGrid columns="2">
                <f:facet name="header">
                  Promesa de pago # 2
                </f:facet>
                Monto negociado:
                &nbsp;&nbsp;&nbsp;&nbsp;
                <p:inputText value="#{conveniosBean.saldosNuevasPromesas[1]}" required="true" requiredMessage="Debe ingresar una cantidad." />
                Fecha pactada:
                &nbsp;&nbsp;&nbsp;&nbsp;
                <p:calendar value="#{conveniosBean.fechasNuevasPromesas[1]}" showOn="button" required="true" requiredMessage="Debe indicar una fecha." />
              </p:panelGrid>
            </p:outputPanel>
            <p:outputPanel style="text-align:center;" rendered="#{conveniosBean.habilita3}">
              <p:panelGrid columns="2">
                <f:facet name="header">
                  Promesa de pago # 3
                </f:facet>
                Monto negociado:
                &nbsp;&nbsp;&nbsp;&nbsp;
                <p:inputText value="#{conveniosBean.saldosNuevasPromesas[2]}" required="true" requiredMessage="Debe ingresar una cantidad." />
                Fecha pactada:
                &nbsp;&nbsp;&nbsp;&nbsp;
                <p:calendar value="#{conveniosBean.fechasNuevasPromesas[2]}" showOn="button" required="true" requiredMessage="Debe indicar una fecha." />
              </p:panelGrid>
            </p:outputPanel>
            <p:outputPanel style="text-align:center;" rendered="#{conveniosBean.habilita4}">
              <p:panelGrid columns="2">
                <f:facet name="header">
                  Promesa de pago # 4
                </f:facet>
                Monto negociado:
                &nbsp;&nbsp;&nbsp;&nbsp;
                <p:inputText value="#{conveniosBean.saldosNuevasPromesas[3]}" required="true" requiredMessage="Debe ingresar una cantidad." />
                Fecha pactada:
                &nbsp;&nbsp;&nbsp;&nbsp;
                <p:calendar value="#{conveniosBean.fechasNuevasPromesas[3]}" showOn="button" required="true" requiredMessage="Debe indicar una fecha." />
              </p:panelGrid>
            </p:outputPanel>
            <p:outputPanel style="text-align:center;" rendered="#{conveniosBean.habilita5}">
              <p:panelGrid columns="2">
                <f:facet name="header">
                  Promesa de pago # 5
                </f:facet>
                Monto negociado:
                &nbsp;&nbsp;&nbsp;&nbsp;
                <p:inputText value="#{conveniosBean.saldosNuevasPromesas[4]}" required="true" requiredMessage="Debe ingresar una cantidad." />
                Fecha pactada:
                &nbsp;&nbsp;&nbsp;&nbsp;
                <p:calendar value="#{conveniosBean.fechasNuevasPromesas[4]}" showOn="button" required="true" requiredMessage="Debe indicar una fecha." />
              </p:panelGrid>
            </p:outputPanel>
            <p:outputPanel style="text-align:center;" rendered="#{conveniosBean.habilita6}">
              <p:panelGrid columns="2">
                <f:facet name="header">
                  Promesa de pago # 6
                </f:facet>
                Monto negociado:
                &nbsp;&nbsp;&nbsp;&nbsp;
                <p:inputText value="#{conveniosBean.saldosNuevasPromesas[5]}" required="true" requiredMessage="Debe ingresar una cantidad." />
                Fecha pactada:
                &nbsp;&nbsp;&nbsp;&nbsp;
                <p:calendar value="#{conveniosBean.fechasNuevasPromesas[5]}" showOn="button" required="true" requiredMessage="Debe indicar una fecha." />
              </p:panelGrid>
            </p:outputPanel>
            <p:outputPanel style="text-align:center;" rendered="#{conveniosBean.habilita7}">
              <p:panelGrid columns="2">
                <f:facet name="header">
                  Promesa de pago # 7
                </f:facet>
                Monto negociado:
                &nbsp;&nbsp;&nbsp;&nbsp;
                <p:inputText value="#{conveniosBean.saldosNuevasPromesas[6]}" required="true" requiredMessage="Debe ingresar una cantidad." />
                Fecha pactada:
                &nbsp;&nbsp;&nbsp;&nbsp;
                <p:calendar value="#{conveniosBean.fechasNuevasPromesas[6]}" showOn="button" required="true" requiredMessage="Debe indicar una fecha." />
              </p:panelGrid>
            </p:outputPanel>
            <br />
            <br />
            <div align="center">
              <p:commandButton value="Agregar promesas" icon="ui-icon-check" actionListener="#{conveniosBean.agregarPromesas()}" update="growl" rendered="#{conveniosBean.habilitaPromesas}" />
              &nbsp;&nbsp;&nbsp;&nbsp;
              <p:commandButton value="Cancelar" icon="ui-icon-close" actionListener="#{conveniosBean.borrarConvenio()}" process="@this" oncomplete="PF('agregarConvenioDialog').hide();" update=":formConvenios" rendered="#{conveniosBean.habilitaPromesas}" />
            </div>
          </h:form>
        </p:dialog>
      </div>
    </div><!-- /main-container -->
    <!-- Footer ================================================== -->
    <ui:include src="barraInferior.xhtml" />
  </body>
</html>