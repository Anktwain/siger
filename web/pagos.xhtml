<?xml version='1.0' encoding='UTF-8' ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns:f="http://xmlns.jcp.org/jsf/core" 
      xmlns:h="http://xmlns.jcp.org/jsf/html" 
      xmlns:p="http://primefaces.org/ui" 
      xmlns:ui="http://xmlns.jcp.org/jsf/facelets" 
      xmlns="http://www.w3.org/1999/xhtml">
  <h:head>
    <meta charset="utf-8"></meta>
    <title>SigerWeb - Pagos</title>
  </h:head>
  <f:metadata>
    <f:event listener="#{indexBean.verificarAcceso('pagos')}" type="preRenderView" />
  </f:metadata>
  <body>
    <p:growl id="growl" showDetail="true" sticky="true" />
    <!-- Overlay Div -->
    <div id="overlay" class="transparent" style="display: none"></div>
    <ui:include src="barraSuperior.xhtml" />
    <ui:include src="barraLateral.xhtml" />
    <div id="main-container">
      <div id="breadcrumb">
        <ul class="breadcrumb">
          <li>
            <i class="fa fa-home">
            </i>
            <a href="#{indexBean.vista}">Inicio</a>
          </li>
          <li class="active">
            Pagos
          </li>
        </ul>
      </div>
      <div class="main-header clearfix">
        <div class="page-title">
          <h3 class="no-margin">Pagos</h3>
          <span>Consulte informaci&oacute;n de los pagos que han cargado los gestores al sistema.</span>
          <span>Apruebe pagos para que los montos se apliquen a los creditos o rechaze pagos que no cumplan los requisitos.</span>
        </div>
      </div>
      <div class="panel panel-default">
        <div class="panel-tab clearfix">
          <ul class="tab-bar">
            <li><a href="#pestanaRevisionPagos" data-toggle="tab" title="Click aqui si desea ver los pagos pendientes de revision"><h2><i class="fa fa-check"></i> Revision de pagos</h2></a></li>
            &nbsp;
            <li><a href="#pestanaTodosPagos" data-toggle="tab" title="Click aqui si desea ver el historial de pagos"><h2><i class="fa fa-usd"></i> Consulta de pagos</h2></a></li>
            &nbsp;
            <li><a href="#pestanaPagosGestores" data-toggle="tab" title="Click aqui si desea ver los detalles de pagos por gestor"><h2><i class="fa fa-user"></i> Pagos por gestor</h2></a></li>
          </ul>
        </div>
        <div class="panel-body">
          <div class="tab-content">
            <!-- AQUI VA LA TABLA QUE MUESTRA LOS PAGOS POR APROBAR -->
            <div class="tab-pane fade" id="pestanaRevisionPagos">
              <h:form id="formRevisionPagos">
                <p:contextMenu for="revisionPagos" style="width:230px;">
                  <p:menuitem value="Visualizar comprobantes" icon="ui-icon-zoomin" actionListener="#{pagosBean.visualizarListaComprobantes(pagosBean.pagoSeleccionado)}" update=":formVisualizarPagos" />
                  <p:menuitem value="Enviar a revision" icon="ui-icon-mail-closed" actionListener="#{pagosBean.verificarCorreoRevision()}" update="growl, mailPagoForm" />
                  <p:menuitem value="Aprobar pago" icon="ui-icon-check" oncomplete="PF('confirmacionAprobarPagoDialog').show()" actionListener="#{pagosBean.prepararMontoAprobado()}" update="confirmacionAprobarPagoForm" />
                  <p:menuitem value="Rechazar pago" icon="ui-icon-cancel" oncomplete="PF('confirmacionRechazarPagoDialog').show()" />
                </p:contextMenu>
                <p:dataTable id="revisionPagos" var="pr" value="#{pagosBean.pagosPorRevisar}" rowKey="#{pr.idPago}" selection="#{pagosBean.pagoSeleccionado}" selectionMode="single" emptyMessage="No existen pagos por revisar." paginator="true" rows="15" paginatorPosition="bottom" paginatorAlwaysVisible="false">
                  <p:column headerText="Deudor" style="width:300px;">
                    <h:outputText value="#{pr.promesaPago.convenioPago.credito.deudor.sujeto.nombreRazonSocial}" />
                  </p:column>
                  <p:column headerText="Monto" style="width:100px;"> 
                    <h:outputText value="#{pr.montoPago}" style="float:right">
                      <f:convertNumber  maxFractionDigits="2" currencySymbol="$" minFractionDigits="2" type="currency" />
                    </h:outputText>
                  </p:column>
                  <p:column headerText="Fecha deposito" style="width:100px;"> 
                    <h:outputText value="#{pr.fechaDeposito}" />
                  </p:column>
                  <p:column headerText="Credito" style="width:100px;">
                    <h:outputText value="#{pr.promesaPago.convenioPago.credito.numeroCredito}" />
                  </p:column>
                  <p:column headerText="Estatus" style="width:150px;"> 
                    <h:outputText value="#{pagosBean.etiquetarEstatus(pr.estatus)}" />
                  </p:column>
                  <p:column headerText="Gestor" style="width:100px;" > 
                    <h:outputText value="#{pr.gestor.usuario.nombreLogin}" />
                  </p:column>
                  <p:column headerText="Producto" style="width:300px;">
                    <h:outputText value="#{pr.promesaPago.convenioPago.credito.subproducto.nombre}" />
                  </p:column>
                  <p:column headerText="Mensualidad" style="width:100px;">
                    <h:outputText value="#{pr.promesaPago.convenioPago.credito.mensualidad}" style="float:right">
                      <f:convertNumber  maxFractionDigits="2" currencySymbol="$" minFractionDigits="2" type="currency" />
                    </h:outputText>
                  </p:column>
                  <p:column headerText="Meses vencidos" style="width:100px;">
                    <h:outputText value="#{pagosBean.obtenerMesesVencidos(pr.promesaPago.convenioPago.credito.idCredito)}" style="float:right" />
                  </p:column>
                </p:dataTable>
              </h:form>
              <hr />
              <h:form id="formVisualizarPagos">
                <p:dataTable id="comprobantesPagos" var="c" value="#{pagosBean.listaComprobantes}" rowKey="#{c.idComprobante}" selection="#{pagosBean.comprobanteSeleccionado}" selectionMode="single" emptyMessage="No existen comprobantes para este pago." rendered="#{pagosBean.habilitaVisualizador}" style="width: 300px;">
                  <p:column headerText="Comprobantes para este pago">
                    <p:commandLink value="Ver comprobante" actionListener="#{pagosBean.visualizar(c)}" />
                  </p:column>
                </p:dataTable>
              </h:form>
            </div>
            <!-- AQUI VA LA TABLA QUE MUESTRA TODOS LOS PAGOS DEL SISTEMA -->
            <div class="tab-pane fade" id="pestanaTodosPagos">
              <h:form id="formTodosPagos">
                <table>
                  <tr>
                    <td>
                      <h4 class="no-margin">Fecha inicio:</h4>
                      <br />
                      <p:calendar id="startDate" value="#{pagosBean.fechaInicio}" showOn="button" required="true" requiredMessage="Debe indicar una fecha inicial.">
                        <p:ajax event="dateSelect" update="endDate" />
                      </p:calendar>
                    </td>
                    <td style="padding-left: 20px;"></td>
                    <td style="padding-left: 20px;">
                      <h4 class="no-margin">Fecha fin:</h4>
                      <br />
                      <p:calendar id="endDate" value="#{pagosBean.fechaFin}" showOn="button" required="true" requiredMessage="Debe indicar una fecha final." />
                    </td>
                  </tr>
                  <tr>
                    <td style="padding-top: 20px"></td>
                  </tr>
                  <tr>
                    <td>
                      <p:commandButton value="Buscar" icon="ui-icon-search" actionListener="#{pagosBean.buscar()}" update="growl, todosPagos" />
                    </td>
                  </tr>
                </table>
                <br />
                <p:dataTable id="todosPagos" var="p" value="#{pagosBean.listaPagos}" rowKey="#{p.idPago}" emptyMessage="No existen pagos." paginator="true" rows="15" paginatorPosition="bottom" paginatorAlwaysVisible="false" style="width: 1500px;" rendered="#{pagosBean.habilitaTabla}">
                  <!-- TO FIX -->
                  <!-- AGREGAR UN BOTON PARA QUE EL ADMINISTRADOR MARQUE SI YA PAGO LA COMISION DE ESTE PAGO AL GESTOR -->
                  <p:column headerText="Fecha deposito" style="width:100px;"> 
                    <h:outputText value="#{p.fechaDeposito}" />
                  </p:column>
                  <p:column headerText="Monto pago" style="width:150px;"> 
                    <h:outputText value="#{p.montoPago}">
                      <f:convertNumber  maxFractionDigits="2" currencySymbol="$" minFractionDigits="2" type="currency" />
                    </h:outputText>
                  </p:column>
                  <p:column headerText="Monto aprobado" style="width:150px;"> 
                    <h:outputText value="#{p.montoAprobado}">
                      <f:convertNumber  maxFractionDigits="2" currencySymbol="$" minFractionDigits="2" type="currency" />
                    </h:outputText>
                  </p:column>
                  <p:column headerText="Credito" style="width:100px;"> 
                    <h:outputText value="#{p.promesaPago.convenioPago.credito.numeroCredito}" />
                  </p:column>
                  <p:column headerText="Deudor" style="width:250px;"> 
                    <h:outputText value="#{p.promesaPago.convenioPago.credito.deudor.sujeto.nombreRazonSocial}" />
                  </p:column>
                  <p:column headerText="Estatus" style="width:150px;"> 
                    <h:outputText value="#{pagosBean.etiquetarEstatus(p.estatus)}" />
                  </p:column>
                  <p:column headerText="Fecha revision" style="width:100px;"> 
                    <h:outputText value="#{p.fechaRegistro}" />
                  </p:column>
                  <p:column headerText="Revisor" style="width:100px;"> 
                    <h:outputText value="#{p.revisor}" />
                  </p:column>
                  <p:column headerText="Gestor" style="width:100px;"> 
                    <h:outputText value="#{p.gestor.usuario.nombreLogin}" />
                  </p:column>
                  <p:column headerText="Observaciones" style="width:200px;">
                    <h:outputText value="#{p.observacionRevisor}"/>
                  </p:column>
                  <f:facet name="footer">
                    <div align="right">
                      <h:commandLink actionListener="#{pagosBean.reportarExportacion('xls')}">
                        <p:graphicImage name="/img/iconos/excel.png" width="40" rendered="#{pagosBean.permitirExport}" />
                        <p:dataExporter type="xls" target="todosPagos" fileName="#{pagosBean.nombreArchivo}" />
                      </h:commandLink>
                      &nbsp;&nbsp;&nbsp;&nbsp;
                      <h:commandLink  actionListener="#{pagosBean.reportarExportacion('pdf')}">
                        <p:graphicImage name="/img/iconos/pdf.png" width="40" rendered="#{pagosBean.permitirExport}" />
                        <p:dataExporter type="pdf" preProcessor="#{pagosBean.preparaPdf}" target="todosPagos" fileName="#{pagosBean.nombreArchivo}"/>
                      </h:commandLink>
                    </div>
                  </f:facet>
                </p:dataTable>
              </h:form>
            </div>
            <!-- AQUI VA LA TABLA QUE MUESTRA LOS PAGOS POR GESTORES Y DETALLES DE COBRANZA -->
            <div class="tab-pane fade" id="pestanaPagosGestores">
              <h:form id="formPagosGestores">
                <p:dataTable id="pagosGestores" var="pg" value="#{pagosBean.listaPagosGestor}" rowKey="#{pg.idGestor}" emptyMessage="No existe informacion de los pagos por gestor." paginator="true" rows="15" paginatorPosition="bottom" paginatorAlwaysVisible="false" style="width: 750px;">
                  <p:column headerText="Gestor" style="width:150px;"> 
                    <h:outputText value="#{pg.gestor}" />
                  </p:column>
                  <p:column headerText="Monto pagos aprobados" style="width:200px;"> 
                    <h:outputText value="#{pg.montoPagos}" style="float: right;">
                      <f:convertNumber  maxFractionDigits="2" currencySymbol="$" minFractionDigits="2" type="currency" />
                    </h:outputText>
                  </p:column>
                  <p:column headerText="Monto creditos en gestion" style="width:200px;"> 
                    <h:outputText value="#{pg.montoPrometido}" style="float: right;">
                      <f:convertNumber  maxFractionDigits="2" currencySymbol="$" minFractionDigits="2" type="currency" />
                    </h:outputText>
                  </p:column>
                  <p:column headerText="Eficiencia" style="width:150px;"> 
                    <h:outputText value="#{pg.eficiencia} %" style="float: right;">
                      <f:convertNumber minFractionDigits="4" maxFractionDigits="4" type="number" />
                    </h:outputText>
                  </p:column>
                </p:dataTable>
              </h:form>
            </div>
          </div>
        </div>
        <!-- DIALOGO BARRA DE CARGA -->
        <p:ajaxStatus onstart="PF('statusDialog').show()" onsuccess="PF('statusDialog').hide()" />
        <p:dialog widgetVar="statusDialog" modal="true" draggable="false" closable="false" resizable="false" showHeader="false" >
          <p:graphicImage library="img" name="loadingBarra.gif" />
        </p:dialog>
        <!-- DIALOGO DE REVISION DE PAGOS -->
        <p:dialog id="dlgRevisionPago" widgetVar="detallePagoDialog" position="right top" resizable="false" width="500" height="850" header="Revisar pago">
          <h:form id="formVisorPago">
            <h:graphicImage url="#{pagosBean.urlImagen}" width="490" height="840" />
          </h:form>
        </p:dialog>
        <!-- DIALOGO DE CORREO ELECTRONICO -->
        <p:dialog id="dlgMailPago" widgetVar="mailPagoDialog" resizable="false" width="500" header="Enviar pago a revision">
          <h:form id="mailPagoForm">
            Remitente:
            &nbsp;&nbsp;&nbsp;&nbsp;
            <p:selectOneMenu value="#{pagosBean.remitente}">
              <f:selectItems value="#{pagosBean.listaRemitentes}" />
            </p:selectOneMenu>
            <br />
            <br />
            Destinatario(s):
            &nbsp;&nbsp;&nbsp;&nbsp;
            <p:selectCheckboxMenu value="#{pagosBean.destinatarios}" label="Seleccione" style="width: 250px; font-size: 16px; font-family: 'Open Sans',sans-serif;">
              <f:selectItems value="#{pagosBean.listaDestinatarios}" />
            </p:selectCheckboxMenu>
            <br />
            <br />
            Copia oculta para:
            &nbsp;&nbsp;&nbsp;&nbsp;
            <p:selectOneMenu value="#{pagosBean.copia}">
              <f:selectItems value="#{pagosBean.listaCorreos}" />
            </p:selectOneMenu>
            <br />
            <br />
            <br />
            Asunto
            <br />
            <p:inputTextarea value="#{pagosBean.asunto}" rows="2" cols="50" />
            <br />
            <br />
            Cuerpo del mensaje:
            <br />
            <p:inputTextarea value="#{pagosBean.mensajeCorreo}" rows="4" cols="50" />
            <br />
            <br />
            <div align="center">
              <p:commandButton value="Enviar a revision" icon="ui-icon-mail-closed" actionListener="#{pagosBean.enviarCorreoBanco()}" oncomplete="PF('mailPagoDialog').hide()" update="growl, formRevisionPagos" />
              &nbsp;&nbsp;&nbsp;&nbsp;
              <p:commandButton value="Agregar correos" icon="ui-icon-plus" oncomplete="PF('agregarCorreoDialog').show()"/>
              &nbsp;&nbsp;&nbsp;&nbsp;
              <p:commandButton value="Cancelar" icon="ui-icon-close" oncomplete="PF('mailPagoDialog').hide()" />
            </div>
          </h:form>
        </p:dialog>
        <!-- DIALOGO DE CONFIRMACION APROBAR PAGO -->
        <p:dialog id="dlgConfirmacionAprobarPago" widgetVar="confirmacionAprobarPagoDialog" modal="true" resizable="false" header="Confirme esta accion">
          <h:form id="confirmacionAprobarPagoForm">
            Realmente desea aprobar este pago?
            <br />
            <br />
            Informacion del pago:
            &nbsp;&nbsp;&nbsp;&nbsp;
            <p:selectOneMenu value="#{pagosBean.observacionParaBanco}">
              <f:selectItems value="#{pagosBean.listaObservacionesPago}" />
            </p:selectOneMenu>
            <br />
            <br />
            Monto aprobado:
            &nbsp;&nbsp;&nbsp;&nbsp;
            <p:inputText value="#{pagosBean.montoAprobado}" type="number" />
            <br />
            <br />
            <div align="center">
              <p:commandButton value="Aceptar" icon="ui-icon-check" oncomplete="PF('confirmacionAprobarPagoDialog').hide()" actionListener="#{pagosBean.aprobarPago()}" update="growl, formRevisionPagos, formTodosPagos:todosPagos" />
              &nbsp;&nbsp;&nbsp;&nbsp;
              <p:commandButton value="Cancelar" icon="ui-icon-close" oncomplete="PF('confirmacionAprobarPagoDialog').hide()" />
            </div>
          </h:form>
        </p:dialog>
        <!-- DIALOGO DE CONFIRMACION RECHAZAR PAGO -->
        <p:dialog id="dlgConfirmacionRechazarPago" widgetVar="confirmacionRechazarPagoDialog" modal="true" resizable="false" header="Confirme esta accion">
          <h:form id="confirmacionRechazarPagoForm">
            Realmente desea rechazar este pago?
            <br />
            <br />
            Motivo del rechazo:
            &nbsp;&nbsp;&nbsp;&nbsp;
            <p:inputText value="#{pagosBean.observacionRechazo}" type="text" size="30" maxlength="30" />
            <br />
            <br />
            <div align="center">
              <p:commandButton value="Aceptar" icon="ui-icon-check" oncomplete="PF('confirmacionRechazarPagoDialog').hide()" actionListener="#{pagosBean.rechazarPago()}" update=":growl, formRevisionPagos, formTodosPagos:todosPagos" />
              &nbsp;&nbsp;&nbsp;&nbsp;
              <p:commandButton value="Cancelar" icon="ui-icon-close" oncomplete="PF('confirmacionRechazarPagoDialog').hide()" />
            </div>
          </h:form>
        </p:dialog>
        <p:dialog id="dlgAgregarCorreo" widgetVar="agregarCorreoDialog" modal="true" resizable="false" draggable="false" header="Agregue una direccion de correo">
          <h:form id="agregarCorreoForm">
            Direccion de correo electronico:
            <br />
            <p:inputText value="#{pagosBean.nuevoCorreo}" type="email" required="true" requiredMessage="Debe indicar una direccion de correo" size="30" maxlength="60" />
            <br />
            <br />
            Tipo:
            &nbsp;&nbsp;&nbsp;&nbsp;
            <p:selectOneMenu value="#{pagosBean.tipoNuevoCorreo}">
              <f:selectItem itemLabel="Remitente" itemValue="Remitente" />
              <f:selectItem itemLabel="Destinatario" itemValue="Destinatario" />
            </p:selectOneMenu>
            <br />
            <br />
            <div align="center">
              <p:commandButton value="Aceptar" icon="ui-icon-check" oncomplete="PF('agregarCorreoDialog').hide()" actionListener="#{pagosBean.agregarCorreo()}" update=":growl, mailPagoForm" />
              &nbsp;&nbsp;&nbsp;&nbsp;
              <p:commandButton value="Cancelar" icon="ui-icon-close" oncomplete="PF('agregarCorreoDialog').hide()" />
            </div>
          </h:form>
        </p:dialog>
        <p:dialog id="dlgRevisionPago" widgetVar="comprobantePagoDialog" position="right top" resizable="false" width="500" height="850" header="Revisar comprobante">
          <h:form id="formVisorPago">
            <h:outputText value="#{pagosBean.comprobanteSeleccionado.nombreComprobante}" />
            <br />
            <br />
            <h:graphicImage url="#{pagosBean.urlImagen}" height="790" width="490"/>
          </h:form>
        </p:dialog>
      </div>
    </div>
  </body>
</html>